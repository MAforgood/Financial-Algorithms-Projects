//@version=5
strategy("VWAP Strategy with MACD Filter", shorttitle="VWAP Strategy + MACD", overlay=true)

// Parameters for VWAP
vwapLength = input.int(14, title="VWAP Length", minval=1, maxval=100, step=1)

// Parameters for MACD
fastLength = input.int(12, title="Fast Length", minval=1, maxval=100, step=1)
slowLength = input.int(26, title="Slow Length", minval=1, maxval=100, step=1)
signalLength = input.int(9, title="Signal Length", minval=1, maxval=100, step=1)

// Define Start and End Dates
startYear = input.int(2021, title="Start Year", minval=1900)
startMonth = input.int(1, title="Start Month", minval=1, maxval=12)
startDay = input.int(1, title="Start Day", minval=1, maxval=31)
endYear = input.int(2021, title="End Year", minval=1900)
endMonth = input.int(3, title="End Month", minval=1, maxval=12)
endDay = input.int(31, title="End Day", minval=1, maxval=31)

// Calculate VWAP with date range filter
var float vwap = na
if (time >= timestamp(startYear, startMonth, startDay, 0, 0) and time <= timestamp(endYear, endMonth, endDay, 23, 59))
    vwap := ta.sma(close * volume, vwapLength) / ta.sma(volume, vwapLength)

// Calculate MACD
[macdLine, signalLine, _] = ta.macd(close, fastLength, slowLength, signalLength)

// Buy and Sell conditions
buyCondition = ta.crossover(close, vwap) and ta.crossover(macdLine, signalLine)
sellCondition = ta.crossunder(close, vwap) and ta.crossunder(macdLine, signalLine)

// Define stop loss and take profit levels
stopLossPercentage = input.float(1.4, title="Stop Loss Percentage", minval=1, maxval=10, step=1)
takeProfitPercentage = input.float(30.82, title="Take Profit Percentage", minval=1, maxval=40, step=1)
stopLossPrice = vwap * (1 - stopLossPercentage / 100)
takeProfitPrice = vwap * (1 + takeProfitPercentage / 100)

// Plot VWAP and MACD on the chart
plot(vwap, color=color.blue, title="VWAP")
plot(macdLine - signalLine, color=color.red, title="MACD Histogram")

var float stopLossLevel = na
var float takeProfitLevel = na

// Strategy logic
if (buyCondition)
    stopLossLevel := stopLossPrice
    takeProfitLevel := takeProfitPrice

if (sellCondition)
    stopLossLevel := na
    takeProfitLevel := na

strategy.entry("Buy", strategy.long, when = buyCondition)

if (stopLossLevel > 0)
    strategy.exit("Take Profit/Stop Loss", from_entry = "Buy", stop = stopLossLevel, limit = takeProfitLevel)

// Plot stop loss and take profit levels on the chart
plotshape(series=sellCondition, title="Sell Signal", location=location.belowbar, color=color.red, style=shape.triangleup, text="Sell")
plotshape(series=buyCondition, title="Buy Signal", location=location.abovebar, color=color.green, style=shape.triangledown, text="Buy")
